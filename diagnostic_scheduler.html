<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>æ´»å‹•æª”æœŸæ’ç¨‹è¡¨ - è¨ºæ–·ç‰ˆ</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body {
      font-family: 'Microsoft JhengHei', Arial, sans-serif;
      background: linear-gradient(135deg, #833B36 0%, #AD9667 100%);
      min-height: 100vh;
      padding: 20px;
      color: #2c3e50;
      margin: 0;
    }
    .container { max-width: 800px; margin: 0 auto; background: rgba(255, 255, 255, 0.95); border-radius: 20px; padding: 30px; box-shadow: 0 8px 32px rgba(131, 59, 54, 0.15); }
    .header { text-align: center; margin-bottom: 30px; }
    .header h1 { color: #833B36; margin-bottom: 10px; }
    .diagnostic-panel, .config-panel { background: #f8f9fa; border-radius: 10px; padding: 20px; margin-bottom: 20px; }
    .diagnostic-panel { border-left: 4px solid #007bff; }
    .status-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #dee2e6; }
    .status-label { font-weight: 600; color: #495057; }
    .status-value { padding: 4px 12px; border-radius: 20px; font-size: 0.9em; font-weight: 500; }
    .status-success { background: #d4edda; color: #155724; }
    .status-error { background: #f8d7da; color: #721c24; }
    .status-warning { background: #fff3cd; color: #856404; }
    .status-info { background: #d1ecf1; color: #0c5460; }
    .log-panel { background: #212529; color: #ffffff; border-radius: 10px; padding: 20px; margin-bottom: 20px; font-family: 'Courier New', monospace; font-size: 0.9em; max-height: 300px; overflow-y: auto; }
    .button-group { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .btn { padding: 10px 20px; border: none; border-radius: 25px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; font-size: 0.9em; }
    .btn-primary { background: linear-gradient(135deg, #833B36, #AD9667); color: white; }
    .btn-success { background: #28a745; color: white; }
    .btn-warning { background: #ffc107; color: #212529; }
    .btn-info { background: #17a2b8; color: white; }
    .btn:hover { transform: translateY(-2px); }
    .config-item { margin-bottom: 10px; font-size: 0.9em; }
    .config-label { font-weight: 600; color: #495057; display: inline-block; width: 120px; }
    .config-value { font-family: 'Courier New', monospace; background: white; padding: 2px 6px; border-radius: 4px; word-break: break-all; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ”§ Google API ç™»å…¥è¨ºæ–·å·¥å…·ï¼ˆPopup ç™»å…¥ï¼‰</h1>
    </div>
    <div class="config-panel">
      <h3>ğŸ“‹ ç•¶å‰é…ç½®</h3>
      <div class="config-item"><span class="config-label">ç¶²ç«™ï¼š</span><span class="config-value" id="currentDomain"></span></div>
      <div class="config-item"><span class="config-label">å”å®šï¼š</span><span class="config-value" id="currentProtocol"></span></div>
      <div class="config-item"><span class="config-label">å®Œæ•´ç¶²å€ï¼š</span><span class="config-value" id="currentUrl"></span></div>
      <div class="config-item"><span class="config-label">API é‡‘é‘°ï¼š</span><span class="config-value">AIzaSyAkJNxalxCSVuf5bqUg_vRyZJxvU_YFohM</span></div>
      <div class="config-item"><span class="config-label">ç”¨æˆ¶ç«¯ IDï¼š</span><span class="config-value">930590768575-j1cutl028ggcl8lcplfrtnjnurne4dcm.apps.googleusercontent.com</span></div>
    </div>
    <div class="diagnostic-panel">
      <h3>ğŸ” ç™»å…¥æ¸¬è©¦</h3>
      <div class="status-item">
        <span class="status-label">Google API è¼‰å…¥</span>
        <span class="status-value status-success" id="gapiStatus">âœ… å·²è¼‰å…¥</span>
      </div>
      <div class="status-item">
        <span class="status-label">ç™»å…¥ç‹€æ…‹</span>
        <span class="status-value status-info" id="signInStatus">æœªç™»å…¥</span>
      </div>
    </div>
    <div class="button-group">
      <button class="btn btn-primary" onclick="handleLogin()">ğŸ” ç™»å…¥ Google</button>
      <button id="fetchSheetBtn" class="btn btn-success">ğŸ“„ è®€å–è©¦ç®—è¡¨</button>
      <button id="clearLogs" class="btn btn-info">ğŸ§¹ æ¸…é™¤æ—¥èªŒ</button>
    </div>
    <div class="log-panel" id="logPanel">
      <div id="logContent">ğŸ“ æº–å‚™å°±ç·’ï¼Œè«‹é»æ“Šç™»å…¥</div>
    </div>
  </div>

  <script>
    const CONFIG = {
      apiKey: 'AIzaSyAkJNxalxCSVuf5bqUg_vRyZJxvU_YFohM',
      clientId: '930590768575-j1cutl028ggcl8lcplfrtnjnurne4dcm.apps.googleusercontent.com',
      scope: 'https://www.googleapis.com/auth/spreadsheets.readonly',
      sheetId: '1qRtV3q1sHoHOlhQ0NnkSRzTliDP5xKL2v0Ayz1Ik0Nc',
      sheetRange: 'A1:H10'
    };

    let accessToken = null;
    let tokenClient = null;

    function log(message) {
      const time = new Date().toLocaleTimeString();
      const el = document.createElement('div');
      el.style.color = '#17a2b8';
      el.textContent = `[${time}] ${message}`;
      const logPanel = document.getElementById('logContent');
      logPanel.appendChild(el);
      logPanel.scrollTop = logPanel.scrollHeight;
      console.log('[Log]', message);
    }

    function updateStatus(id, state, text) {
      const el = document.getElementById(id);
      el.className = `status-value status-${state}`;
      el.textContent = text;
    }

    function handleLogin() {
      if (!tokenClient) {
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: CONFIG.clientId,
          scope: CONFIG.scope,
          redirect_uri: 'https://orangesmall.github.io/Announcement/diagnostic_scheduler.html',
          callback: (response) => {
            if (response && response.access_token) {
              accessToken = response.access_token;
              updateStatus('signInStatus', 'success', 'âœ… å·²ç™»å…¥');
              log('âœ… å–å¾— Access Tokenï¼š' + accessToken);
            } else {
              updateStatus('signInStatus', 'error', 'âŒ ç™»å…¥å¤±æ•—');
              log('âŒ æœªå–å¾— Access Token');
            }
          }
        });
      }
      tokenClient.requestAccessToken();
      log('ğŸ” é–‹å§‹é€²è¡Œ Google ç™»å…¥');
    }

    async function fetchSheetData() {
      if (!accessToken) {
        log('âš ï¸ è«‹å…ˆç™»å…¥ Google');
        return;
      }
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.sheetId}/values/${CONFIG.sheetRange}?key=${CONFIG.apiKey}`;
      const res = await fetch(url, {
        headers: {
          Authorization: `Bearer ${accessToken}`
        }
      });
      const data = await res.json();
      if (data.values) {
        log('ğŸ“„ å–å¾—è©¦ç®—è¡¨è³‡æ–™ï¼š');
        console.log(data.values);
        data.values.forEach(row => log(row.join(' | ')));
      } else {
        log('âŒ ç„¡æ³•è®€å–è©¦ç®—è¡¨è³‡æ–™');
        console.error(data);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('currentDomain').textContent = window.location.hostname;
      document.getElementById('currentProtocol').textContent = window.location.protocol;
      document.getElementById('currentUrl').textContent = window.location.href;
      document.getElementById('clearLogs').addEventListener('click', () => {
        document.getElementById('logContent').innerHTML = 'ğŸ“ æ—¥èªŒå·²æ¸…é™¤';
      });
      document.getElementById('fetchSheetBtn').addEventListener('click', fetchSheetData);
    });
  </script>
</body>
</html>
