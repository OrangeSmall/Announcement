<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>活動檔期排程表 - 診斷版</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #833B36 0%, #AD9667 100%);
            min-height: 100vh;
            padding: 20px;
            color: #2c3e50;
            margin: 0;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(131, 59, 54, 0.15);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #833B36;
            margin-bottom: 10px;
        }

        .diagnostic-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #007bff;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .status-item:last-child {
            border-bottom: none;
        }

        .status-label {
            font-weight: 600;
            color: #495057;
        }

        .status-value {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 500;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
        }

        .status-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .log-panel {
            background: #212529;
            color: #ffffff;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 300px;
            overflow-y: auto;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .btn-primary {
            background: linear-gradient(135deg, #833B36, #AD9667);
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .config-panel {
            background: #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .config-item {
            margin-bottom: 10px;
            font-size: 0.9em;
        }

        .config-label {
            font-weight: 600;
            color: #495057;
            display: inline-block;
            width: 120px;
        }

        .config-value {
            font-family: 'Courier New', monospace;
            background: white;
            padding: 2px 6px;
            border-radius: 4px;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔧 Google API 診斷工具</h1>
            <p>檢測 Google Sheets API 連接狀態</p>
        </div>

        <!-- 當前配置 -->
        <div class="config-panel">
            <h3>📋 當前配置</h3>
            <div class="config-item">
                <span class="config-label">網域：</span>
                <span class="config-value" id="currentDomain">載入中...</span>
            </div>
            <div class="config-item">
                <span class="config-label">協定：</span>
                <span class="config-value" id="currentProtocol">載入中...</span>
            </div>
            <div class="config-item">
                <span class="config-label">完整網址：</span>
                <span class="config-value" id="currentUrl">載入中...</span>
            </div>
            <div class="config-item">
                <span class="config-label">API 金鑰：</span>
                <span class="config-value">AIzaSyAkJN***</span>
            </div>
            <div class="config-item">
                <span class="config-label">用戶端 ID：</span>
                <span class="config-value">930590768575-j1c***</span>
            </div>
        </div>

        <!-- 診斷狀態 -->
        <div class="diagnostic-panel">
            <h3>🔍 診斷狀態</h3>
            <div class="status-item">
                <span class="status-label">Google API 載入</span>
                <span class="status-value status-info" id="gapiStatus">檢查中...</span>
            </div>
            <div class="status-item">
                <span class="status-label">OAuth 初始化</span>
                <span class="status-value status-info" id="authStatus">等待中...</span>
            </div>
            <div class="status-item">
                <span class="status-label">Sheets API 初始化</span>
                <span class="status-value status-info" id="clientStatus">等待中...</span>
            </div>
            <div class="status-item">
                <span class="status-label">用戶授權狀態</span>
                <span class="status-value status-info" id="signInStatus">等待中...</span>
            </div>
            <div class="status-item">
                <span class="status-label">試算表連接</span>
                <span class="status-value status-info" id="sheetsStatus">等待中...</span>
            </div>
        </div>

        <!-- 控制按鈕 -->
        <div class="button-group">
            <button class="btn btn-primary" id="startDiagnostic">🚀 開始診斷</button>
            <button class="btn btn-success" id="testAuth">🔐 測試授權</button>
            <button class="btn btn-warning" id="testSheets">📊 測試試算表</button>
            <button class="btn btn-info" id="clearLogs">🗑️ 清除日誌</button>
        </div>

        <!-- 詳細日誌 -->
        <div class="log-panel" id="logPanel">
            <div>📝 診斷日誌：</div>
            <div id="logContent">等待開始診斷...</div>
        </div>

        <!-- 建議修正 -->
        <div class="diagnostic-panel" id="suggestionsPanel" style="display: none;">
            <h3>💡 建議修正</h3>
            <div id="suggestions"></div>
        </div>
    </div>

    <!-- Google Sheets API -->
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <script>
        // 配置
        const CONFIG = {
            apiKey: 'AIzaSyAkJNxalxCSVuf5bqUg_vRyZJxvU_YFohM',
            clientId: '930590768575-j1cutl028ggcl8lcplfrtnjnurne4dcm.apps.googleusercontent.com',
            spreadsheetId: '1Oy8m425d6vuiX2QiqZJN1PH_b4_TTi6j_qE54lNJZWs',
            scope: 'https://www.googleapis.com/auth/spreadsheets',
            discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"]
        };

        let diagnosticResults = {
            gapiLoaded: false,
            authInitialized: false,
            clientInitialized: false,
            userSignedIn: false,
            sheetsConnected: false
        };

        // 日誌函數
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logContent = document.getElementById('logContent');
            const colorMap = {
                info: '#17a2b8',
                success: '#28a745',
                error: '#dc3545',
                warning: '#ffc107'
            };
            
            const newLog = document.createElement('div');
            newLog.style.color = colorMap[type] || '#ffffff';
            newLog.textContent = `[${timestamp}] ${message}`;
            
            logContent.appendChild(newLog);
            logContent.scrollTop = logContent.scrollHeight;
            
            console.log(`[診斷] ${message}`);
        }

        // 更新狀態顯示
        function updateStatus(elementId, status, text) {
            const element = document.getElementById(elementId);
            element.className = `status-value status-${status}`;
            element.textContent = text;
        }

        // 顯示當前環境資訊
        function showEnvironmentInfo() {
            document.getElementById('currentDomain').textContent = window.location.hostname;
            document.getElementById('currentProtocol').textContent = window.location.protocol;
            document.getElementById('currentUrl').textContent = window.location.href;
            
            log(`當前環境: ${window.location.hostname}`);
            log(`協定: ${window.location.protocol}`);
            log(`完整網址: ${window.location.href}`);
        }

        // 步驟1：檢查 Google API
        function checkGoogleAPI() {
            return new Promise((resolve) => {
                log('檢查 Google API 載入狀態...');
                
                if (typeof gapi !== 'undefined') {
                    diagnosticResults.gapiLoaded = true;
                    updateStatus('gapiStatus', 'success', '✅ 已載入');
                    log('Google API 載入成功', 'success');
                    resolve(true);
                } else {
                    updateStatus('gapiStatus', 'error', '❌ 未載入');
                    log('Google API 未載入', 'error');
                    resolve(false);
                }
            });
        }

        // 步驟2：初始化 OAuth
        function initializeAuth() {
            return new Promise((resolve) => {
                log('初始化 OAuth 2.0...');
                
                gapi.load('auth2', () => {
                    gapi.auth2.init({
                        client_id: CONFIG.clientId
                    }).then(() => {
                        diagnosticResults.authInitialized = true;
                        updateStatus('authStatus', 'success', '✅ 已初始化');
                        log('OAuth 2.0 初始化成功', 'success');
                        resolve(true);
                    }).catch((error) => {
                        updateStatus('authStatus', 'error', '❌ 初始化失敗');
                        log(`OAuth 初始化失敗: ${error.error || error}`, 'error');
                        resolve(false);
                    });
                });
            });
        }

        // 步驟3：初始化 Google Client
        function initializeClient() {
            return new Promise((resolve) => {
                log('初始化 Google Sheets API...');
                
                gapi.load('client', () => {
                    gapi.client.init({
                        apiKey: CONFIG.apiKey,
                        discoveryDocs: CONFIG.discoveryDocs
                    }).then(() => {
                        diagnosticResults.clientInitialized = true;
                        updateStatus('clientStatus', 'success', '✅ 已初始化');
                        log('Google Sheets API 初始化成功', 'success');
                        resolve(true);
                    }).catch((error) => {
                        updateStatus('clientStatus', 'error', '❌ 初始化失敗');
                        log(`Sheets API 初始化失敗: ${error.error || error}`, 'error');
                        resolve(false);
                    });
                });
            });
        }

        // 步驟4：檢查用戶授權
        function checkUserAuth() {
            return new Promise((resolve) => {
                log('檢查用戶授權狀態...');
                
                const authInstance = gapi.auth2.getAuthInstance();
                if (authInstance.isSignedIn.get()) {
                    diagnosticResults.userSignedIn = true;
                    updateStatus('signInStatus', 'success', '✅ 已授權');
                    log('用戶已授權', 'success');
                    resolve(true);
                } else {
                    updateStatus('signInStatus', 'warning', '⚠️ 未授權');
                    log('用戶未授權', 'warning');
                    resolve(false);
                }
            });
        }

        // 步驟5：測試試算表連接
        function testSheetsConnection() {
            return new Promise((resolve) => {
                log('測試 Google Sheets 連接...');
                
                gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: CONFIG.spreadsheetId,
                    range: 'Activities!A1:H1'
                }).then((response) => {
                    diagnosticResults.sheetsConnected = true;
                    updateStatus('sheetsStatus', 'success', '✅ 連接成功');
                    log('Google Sheets 連接成功', 'success');
                    log(`試算表資料: ${JSON.stringify(response.result.values)}`, 'info');
                    resolve(true);
                }).catch((error) => {
                    updateStatus('sheetsStatus', 'error', '❌ 連接失敗');
                    log(`Sheets 連接失敗: ${error.result?.error?.message || error}`, 'error');
                    resolve(false);
                });
            });
        }

        // 執行完整診斷
        async function runDiagnostic() {
            log('=== 開始完整診斷 ===', 'info');
            
            // 重置狀態
            Object.keys(diagnosticResults).forEach(key => {
                diagnosticResults[key] = false;
            });
            
            // 步驟1：檢查 Google API
            const gapiOk = await checkGoogleAPI();
            if (!gapiOk) {
                showSuggestions(['Google API 載入失敗，請檢查網路連線或重新載入頁面']);
                return;
            }
            
            // 步驟2：初始化 OAuth
            const authOk = await initializeAuth();
            if (!authOk) {
                showSuggestions(['OAuth 初始化失敗，請檢查 Google Cloud Console 中的用戶端 ID 設定']);
                return;
            }
            
            // 步驟3：初始化 Client
            const clientOk = await initializeClient();
            if (!clientOk) {
                showSuggestions(['Google Sheets API 初始化失敗，請檢查 API 金鑰設定']);
                return;
            }
            
            // 步驟4：檢查授權
            const authStatus = await checkUserAuth();
            
            // 步驟5：測試連接（如果已授權）
            if (authStatus) {
                await testSheetsConnection();
            }
            
            log('=== 診斷完成 ===', 'info');
            generateSuggestions();
        }

        // 手動授權測試
        function testAuthorization() {
            log('嘗試用戶授權...');
            
            const authInstance = gapi.auth2.getAuthInstance();
            authInstance.signIn().then(() => {
                log('用戶授權成功', 'success');
                updateStatus('signInStatus', 'success', '✅ 已授權');
                diagnosticResults.userSignedIn = true;
            }).catch((error) => {
                log(`授權失敗: ${error.error || error}`, 'error');
                updateStatus('signInStatus', 'error', '❌ 授權失敗');
            });
        }

        // 手動測試試算表
        function testSheetsManually() {
            if (!diagnosticResults.userSignedIn) {
                log('請先完成用戶授權', 'warning');
                return;
            }
            
            testSheetsConnection();
        }

        // 生成建議
        function generateSuggestions() {
            const suggestions = [];
            
            if (!diagnosticResults.gapiLoaded) {
                suggestions.push('Google API 載入失敗：請檢查網路連線並重新載入頁面');
            }
            
            if (!diagnosticResults.authInitialized) {
                suggestions.push('OAuth 初始化失敗：請檢查 Google Cloud Console 中的用戶端 ID 是否正確');
            }
            
            if (!diagnosticResults.clientInitialized) {
                suggestions.push('Sheets API 初始化失敗：請檢查 API 金鑰是否正確且已啟用 Google Sheets API');
            }
            
            if (!diagnosticResults.userSignedIn) {
                suggestions.push('用戶未授權：請點擊「測試授權」按鈕完成 Google 帳號授權');
            }
            
            if (!diagnosticResults.sheetsConnected && diagnosticResults.userSignedIn) {
                suggestions.push(`試算表連接失敗：請檢查以下設定：
                    1. 試算表 ID 是否正確
                    2. 試算表權限是否設為「知道連結的任何人都可以編輯」
                    3. 工作表名稱是否為「Activities」
                    4. Google Cloud Console 中的網域限制是否包含 orangesmall.github.io`);
            }
            
            if (diagnosticResults.gapiLoaded && diagnosticResults.authInitialized && 
                diagnosticResults.clientInitialized && diagnosticResults.userSignedIn && 
                diagnosticResults.sheetsConnected) {
                suggestions.push('🎉 所有測試通過！Google Sheets API 連接正常，可以正常使用同步功能。');
            }
            
            showSuggestions(suggestions);
        }

        // 顯示建議
        function showSuggestions(suggestions) {
            const panel = document.getElementById('suggestionsPanel');
            const content = document.getElementById('suggestions');
            
            content.innerHTML = suggestions.map(suggestion => 
                `<div style="margin-bottom: 10px; padding: 10px; background: white; border-radius: 5px; border-left: 4px solid #007bff;">${suggestion}</div>`
            ).join('');
            
            panel.style.display = 'block';
        }

        // 清除日誌
        function clearLogs() {
            document.getElementById('logContent').innerHTML = '日誌已清除...';
        }

        // 事件監聽器
        document.addEventListener('DOMContentLoaded', () => {
            showEnvironmentInfo();
            
            document.getElementById('startDiagnostic').addEventListener('click', runDiagnostic);
            document.getElementById('testAuth').addEventListener('click', testAuthorization);
            document.getElementById('testSheets').addEventListener('click', testSheetsManually);
            document.getElementById('clearLogs').addEventListener('click', clearLogs);
            
            log('診斷工具已載入，點擊「開始診斷」開始檢測');
        });
    </script>
</body>
</html>